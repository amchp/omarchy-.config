#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: worktree-new <branch> [base-ref]"
  echo ""
  echo "Create a git worktree and tmux session for the given branch."
  echo "If the worktree/session already exist, just switch to it."
  echo ""
  echo "Arguments:"
  echo "  branch     Branch name to create/checkout"
  echo "  base-ref   Base ref to create branch from (default: HEAD)"
  exit 1
}

[[ $# -lt 1 ]] && usage
[[ "$1" == "--help" || "$1" == "-h" ]] && usage

branch="$1"
base_ref="${2:-HEAD}"

# Get main repo root (works from main repo or any worktree)
repo_root="$(git worktree list --porcelain | head -1)"
repo_root="${repo_root#worktree }"
repo_name="$(basename "$repo_root")"
worktrees_dir="$(dirname "$repo_root")/${repo_name}-worktrees"

# Preserve branch hierarchy in directory structure
worktree_path="${worktrees_dir}/${branch}"

# Session name: replace / with __ to avoid tmux confusion, also replace . and :
session_name="${repo_name}/${branch}"
session_name="${session_name//\//__}"
session_name="${session_name//./-}"
session_name="${session_name//:/}"
session_name="${session_name#"${session_name%%[!-]*}"}"

switch_to_session() {
  if [[ -n "${TMUX:-}" ]]; then
    tmux switch-client -t "=$session_name"
  else
    tmux attach-session -t "=$session_name"
  fi
}

# If session already exists, just switch to it
if tmux has-session -t "=$session_name" 2>/dev/null; then
  echo "Session '$session_name' already exists, switching..."
  switch_to_session
  exit 0
fi

# Create worktrees directory if needed
mkdir -p "$worktrees_dir"

# Create the worktree if it doesn't exist
if [[ ! -d "$worktree_path" ]]; then
  # 3-way branch check
  if git show-ref --verify --quiet "refs/heads/${branch}"; then
    # Branch exists locally
    echo "Using existing local branch '${branch}'"
    git worktree add "$worktree_path" "$branch"
  elif git show-ref --verify --quiet "refs/remotes/origin/${branch}"; then
    # Branch exists on remote
    echo "Tracking remote branch 'origin/${branch}'"
    git worktree add "$worktree_path" "$branch"
  else
    # Branch doesn't exist â€” create from base-ref
    echo "Creating new branch '${branch}' from '${base_ref}'"
    git worktree add -b "$branch" "$worktree_path" "$base_ref"
  fi
else
  echo "Worktree already exists at ${worktree_path}"
fi

# Symlink files/directories from main repo if .worktree-symlinks exists
symlinks_config="${repo_root}/.worktree-symlinks"
if [[ -f "$symlinks_config" ]]; then
  echo "Setting up symlinks from .worktree-symlinks..."
  while IFS= read -r link_path || [[ -n "$link_path" ]]; do
    # Skip empty lines and comments
    [[ -z "$link_path" || "$link_path" =~ ^[[:space:]]*# ]] && continue

    source_path="${repo_root}/${link_path}"
    target_path="${worktree_path}/${link_path}"

    if [[ -e "$source_path" ]]; then
      if [[ -e "$target_path" || -L "$target_path" ]]; then
        echo "  Skipping ${link_path} (already exists)"
      else
        # Create parent directory if needed
        target_dir="$(dirname "$target_path")"
        mkdir -p "$target_dir"
        ln -s "$source_path" "$target_path"
        echo "  Symlinked ${link_path}"
      fi
    else
      echo "  Warning: ${link_path} not found in main repo, skipping"
    fi
  done < "$symlinks_config"
fi

# Create tmux session with 3 windows
# Window 1: vertical split (left/right panes)
tmux new-session -d -s "$session_name" -c "$worktree_path" -n "edit"
tmux split-window -h -t "=$session_name:edit" -c "$worktree_path"

# Window 2: single pane
tmux new-window -t "=$session_name" -c "$worktree_path" -n "build"

# Window 3: single pane
tmux new-window -t "=$session_name" -c "$worktree_path" -n "misc"

# Focus on Window 1, left pane
tmux select-window -t "=$session_name:edit"
tmux select-pane -t "=$session_name:edit.0"

# Switch to the session
echo "Created session '$session_name' for worktree at ${worktree_path}"
switch_to_session
